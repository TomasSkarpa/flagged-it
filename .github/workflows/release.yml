name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0). Leave empty to use bump_type instead.'
        required: false
        type: string
      bump_type:
        description: 'Auto-bump version from VERSION file. Use if version field is empty.'
        required: false
        type: choice
        options:
          - none
          - patch
          - minor
          - major
        default: 'patch'

permissions:
  contents: write

jobs:
  # Build Windows and Linux using fyne-cross (cross-compilation from Linux)
  build-cross:
    strategy:
      matrix:
        include:
          - goos: windows
            goarch: amd64
            ext: .exe
          - goos: windows
            goarch: 386
            ext: .exe
          - goos: linux
            goarch: amd64
            ext: ""
          - goos: linux
            goarch: arm64
            ext: ""

    runs-on: ubuntu-latest
    # Docker is required for fyne-cross
    services:
      docker:
        image: docker:24-dind
        options: --privileged
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Get or bump version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.event.inputs.version }}" != "" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            if [[ ! "$VERSION" =~ ^v ]]; then
              VERSION="v$VERSION"
            fi
            echo "$VERSION" > VERSION
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git fetch origin || true
            git add VERSION
            git diff --staged --quiet || git commit -m "chore: set version to $VERSION" || true
            git pull --rebase origin main || git pull --rebase origin HEAD || true
            git push origin HEAD:main || true
          elif [[ "${{ github.event.inputs.bump_type }}" != "none" && "${{ github.event.inputs.bump_type }}" != "" ]]; then
            if [ -f VERSION ]; then
              CURRENT=$(cat VERSION | sed 's/^v//')
            else
              CURRENT="0.0.0"
            fi
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
            case "${{ github.event.inputs.bump_type }}" in
              major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
              minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
              patch) PATCH=$((PATCH + 1)) ;;
            esac
            VERSION="v${MAJOR}.${MINOR}.${PATCH}"
            echo "$VERSION" > VERSION
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git fetch origin || true
            git add VERSION
            git diff --staged --quiet || git commit -m "chore: bump version to $VERSION" || true
            git pull --rebase origin main || git pull --rebase origin HEAD || true
            git push origin HEAD:main || true
          elif [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            # Default to patch bump from 0.0.0 if nothing specified
            echo "Warning: No version specified and VERSION file not found, defaulting to v0.0.1"
            VERSION="v0.0.1"
            echo "$VERSION" > VERSION
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Install fyne-cross
        run: |
          go install github.com/fyne-io/fyne-cross@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
      
      - name: Copy assets for embedding
        run: |
          mkdir -p internal/assetsembed
          cp -r assets internal/assetsembed/assets
      
      - name: Build with fyne-cross
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          BUILD_TIME: ${{ github.event.head_commit.timestamp || github.run_started_at }}
        run: |
          mkdir -p build
          fyne-cross ${{ matrix.goos }} -arch ${{ matrix.goarch }} \
            --app-id com.flaggedit.app \
            --icon assets/favicon/favicon.svg \
            -ldflags "-s -w -X main.Version=${{ env.VERSION }} -X main.BuildTime=${{ env.BUILD_TIME }}" \
            ./cmd
          
          # Copy output from fyne-cross to build directory
          if [ -d "fyne-cross/dist/${{ matrix.goos }}-${{ matrix.goarch }}" ]; then
            find fyne-cross/dist/${{ matrix.goos }}-${{ matrix.goarch }} -type f -executable -exec cp {} build/flagged-it-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }} \; || \
            find fyne-cross/dist/${{ matrix.goos }}-${{ matrix.goarch }} -name "*.exe" -exec cp {} build/flagged-it-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }} \; || \
            find fyne-cross/dist/${{ matrix.goos }}-${{ matrix.goarch }} -type f ! -name "*.md" ! -name "*.txt" | head -1 | xargs -I {} cp {} build/flagged-it-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }}
          fi
      
      - name: Create archive
        shell: bash
        run: |
          cd build
          if [ "${{ matrix.goos }}" = "windows" ]; then
            zip flagged-it-${{ matrix.goos }}-${{ matrix.goarch }}.zip flagged-it-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }}
          else
            tar czf flagged-it-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz flagged-it-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }}
          fi
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flagged-it-${{ matrix.goos }}-${{ matrix.goarch }}
          path: build/flagged-it-${{ matrix.goos }}-${{ matrix.goarch }}.*
          retention-days: 30

  # Build macOS natively (fyne-cross can't cross-compile macOS from Linux)
  build-macos:
    strategy:
      matrix:
        include:
          - goarch: arm64
          - goarch: amd64

    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Install fyne tools
        run: |
          go install fyne.io/tools/cmd/fyne@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
      
      - name: Copy assets for embedding
        run: |
          mkdir -p internal/assetsembed
          cp -r assets internal/assetsembed/assets
      
      - name: Get or bump version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.event.inputs.version }}" != "" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            if [[ ! "$VERSION" =~ ^v ]]; then
              VERSION="v$VERSION"
            fi
            echo "$VERSION" > VERSION
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git fetch origin || true
            git add VERSION
            git diff --staged --quiet || git commit -m "chore: set version to $VERSION" || true
            git pull --rebase origin main || git pull --rebase origin HEAD || true
            git push origin HEAD:main || true
          elif [[ "${{ github.event.inputs.bump_type }}" != "none" && "${{ github.event.inputs.bump_type }}" != "" ]]; then
            if [ -f VERSION ]; then
              CURRENT=$(cat VERSION | sed 's/^v//')
            else
              CURRENT="0.0.0"
            fi
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
            case "${{ github.event.inputs.bump_type }}" in
              major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
              minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
              patch) PATCH=$((PATCH + 1)) ;;
            esac
            VERSION="v${MAJOR}.${MINOR}.${PATCH}"
            echo "$VERSION" > VERSION
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git fetch origin || true
            git add VERSION
            git diff --staged --quiet || git commit -m "chore: bump version to $VERSION" || true
            git pull --rebase origin main || git pull --rebase origin HEAD || true
            git push origin HEAD:main || true
          elif [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            # Default to patch bump from 0.0.0 if nothing specified
            echo "Warning: No version specified and VERSION file not found, defaulting to v0.0.1"
            VERSION="v0.0.1"
            echo "$VERSION" > VERSION
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Build macOS app bundle
        shell: bash
        env:
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
          VERSION: ${{ steps.version.outputs.VERSION }}
          BUILD_TIME: ${{ github.event.head_commit.timestamp || github.run_started_at }}
        run: |
          mkdir -p build
          export SDKROOT=$(xcrun --show-sdk-path)
          
          # Debug: confirm tool and assets
          which fyne || echo "fyne not found"
          fyne --version || true
          ls -l assets/favicon || true
          echo "VERSION=${{ env.VERSION }}"
          
          # Build with version info
          go build -ldflags="-s -w -X main.Version=${{ env.VERSION }} -X main.BuildTime=${{ env.BUILD_TIME }}" \
            -o flagged-it cmd/main.go
          
          # Convert SVG to ICNS for macOS (if needed)
          # For now, use SVG directly - fyne should handle it
          ICON_PATH="assets/favicon/favicon.svg"
          if [ ! -f "$ICON_PATH" ]; then
            echo "Warning: Icon not found at $ICON_PATH, using default"
            ICON_PATH=""
          fi
          
          # Package as macOS app bundle (this bundles assets and hides terminal)
          # Use long-form flags and --release for proper app bundle
          if [ -n "$ICON_PATH" ]; then
            fyne package --os darwin --name flagged-it \
              --app-id com.flaggedit.app \
              --icon "$ICON_PATH" \
              --sourceDir . \
              --executable flagged-it \
              --release
          else
            fyne package --os darwin --name flagged-it \
              --app-id com.flaggedit.app \
              --sourceDir . \
              --executable flagged-it \
              --release
          fi
          
          # Move the .app bundle to build directory
          if [ -d "flagged-it.app" ]; then
            mv flagged-it.app build/flagged-it-darwin-${{ matrix.goarch }}.app
          else
            echo "Error: flagged-it.app not created"
            exit 1
          fi
          
          # Also create a standalone binary for those who prefer it
          if [ -f "flagged-it" ]; then
            mv flagged-it build/flagged-it-darwin-${{ matrix.goarch }}
          fi
      
      - name: Create archive
        shell: bash
        run: |
          cd build
          # Archive the app bundle (recommended for macOS)
          tar czf flagged-it-darwin-${{ matrix.goarch }}.tar.gz flagged-it-darwin-${{ matrix.goarch }}.app
          # Also create a binary-only archive
          tar czf flagged-it-darwin-${{ matrix.goarch }}-binary.tar.gz flagged-it-darwin-${{ matrix.goarch }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flagged-it-darwin-${{ matrix.goarch }}
          path: build/flagged-it-darwin-${{ matrix.goarch }}.*
          retention-days: 30

  create-release:
    needs: [build-cross, build-macos]
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get version
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION)
          else
            echo "Error: VERSION file not found"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get the last tag if it exists
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            # No previous tag, show last 20 commits
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" -20)
          else
            # Show commits since last tag
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREV_TAG}..HEAD)
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="No changes since last release"
            fi
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ steps.version.outputs.VERSION }} -m "Release ${{ steps.version.outputs.VERSION }}" || true
          git push origin ${{ steps.version.outputs.VERSION }} || true
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## Changes
            
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ## Downloads
            
            Download the appropriate file for your platform:
            - **Windows (64-bit)**: `flagged-it-windows-amd64.zip`
            - **Windows (32-bit)**: `flagged-it-windows-386.zip`
            - **macOS (Apple Silicon)**: `flagged-it-darwin-arm64.tar.gz`
            - **macOS (Intel)**: `flagged-it-darwin-amd64.tar.gz`
            - **Linux (64-bit)**: `flagged-it-linux-amd64.tar.gz`
            - **Linux (ARM64)**: `flagged-it-linux-arm64.tar.gz`
          files: artifacts/**/*
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') || contains(steps.version.outputs.VERSION, 'dev') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

